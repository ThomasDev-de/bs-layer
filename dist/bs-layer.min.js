(function($){"use strict";$.bsLayer={version:"1.0.0",getDefaults(){return this.defaults},getConfig(){return this.config},setConfig(config={}){if(!this.utils.isValueEmpty(config)){const newConfig=$.extend(true,{},this.config,config);this.config=newConfig}},config:{ajax:{method:"GET",contentType:"application/x-www-form-urlencoded; charset=UTF-8"},distanceBetweenLayers:100,animationDuration:400,zIndexStart:1050,parent:"body",icons:{close:"bi bi-x-lg",maximize:"bi bi-arrows-angle-expand",minimize:"bi bi-arrows-angle-contract"},onError(_$message){}},defaults:{name:"layer01",title:null,width:undefined,backdrop:false,url:null,closeable:true,expandable:true,queryParams(params){return params},onAll:function(eventName,...args){},onPostBody:function(_$content){},onShow:function(){},onShown:function(){},onHide:function(){},onHidden:function(){},onRefresh:function(_$content){},onCustomEvent:function(_eventName,...params){}},vars:{isAnimating:false,registerGlobalLayerEvents:false,immediate:false,openLayers:[]},customEvent:function(name,eventName,...params){if(!name){return}const cleanName=this.utils.toCamelCase(name);const $layer=$(`.bs-layer[data-name="${cleanName}"]`);if(!$layer.length){return}const $layerBtn=getButtonByLayer($layer);if(!$layerBtn.length){return}triggerEvent($layerBtn,"custom-event",eventName,...params)},closeAll:closeAll,getLayerByName:function(name){const cleanName=this.utils.toCamelCase(name);const $layer=$(`.bs-layer[data-name="${cleanName}"]`);return $layer??null},utils:{toCamelCase(string){const result=string.split("-").map(word=>word.charAt(0).toUpperCase()+word.slice(1)).join("");return result.charAt(0).toLowerCase()+result.slice(1)},getUniqueId(prefix="bs_layer_"){const randomId=Math.random().toString(36).substring(2,10);return prefix+randomId},isValueEmpty(value){if(value===null||typeof value==="undefined"){return true}if(Array.isArray(value)){return value.length===0}if(typeof value==="string"){return value.trim().length===0}if(typeof value==="object"){return Object.keys(value).length===0}return false},executeFunction(functionOrName,...args){if(!functionOrName){return undefined}let func;if(typeof functionOrName==="function"){func=functionOrName}else if(typeof functionOrName==="string"){if(typeof window!=="undefined"&&typeof window[functionOrName]==="function"){func=window[functionOrName]}else{console.error(`Die Funktion "${functionOrName}" konnte nicht im globalen Kontext gefunden werden.`);return undefined}}if(!func){console.error(`UngÃ¼ltige Funktion oder Name: "${functionOrName}"`);return undefined}return func(...args)}}};const namespace=".bs.layer";const backdropId="layerBackdrop";$.fn.bsLayer=function(optionsOrMethod,...args){if($(this).length===0){$.bsLayer.onError("No layer button found!");return}if($(this).length>1){return $(this).each(function(){return $(this).bsLayer(optionsOrMethod,...args)})}const $layerButton=$(this);if(!$layerButton.data("layerConfig")){$layerButton.attr("aria-controls",$.bsLayer.utils.getUniqueId("layer_"));$layerButton.addClass("btn-layer");const options=typeof optionsOrMethod==="object"?optionsOrMethod:{};const settings=$.extend(true,{},$.bsLayer.getDefaults(),$layerButton.data(),options);const layerConfig={settings:settings};$layerButton.data("layerConfig",layerConfig);btnEvents($layerButton)}if(!$.bsLayer.vars.registerGlobalLayerEvents){globalEvents();$.bsLayer.vars.registerGlobalLayerEvents=true}if(typeof optionsOrMethod==="string"){switch(optionsOrMethod){case"show":{$layerButton.trigger("click"+namespace)}break;case"refresh":{const newOptions=args.length>0?args[0]:{};refresh($layerButton,newOptions)}}}return $layerButton};function refresh($layerBtn,options={}){const $layer=getLayerByButton($layerBtn);if(!$layer.length){return}delete options.name;console.log("refresh","getSetting");const settings=getSettings($layerBtn);const{url,ajax,queryParams}=options;if(typeof url==="string"||typeof url==="function"){settings.url=url}if(ajax&&typeof ajax==="object"){settings.ajax=ajax}if(typeof queryParams==="function"){settings.queryParams=queryParams}setSettings($layerBtn,settings);fetchContent($layerBtn,$layer,true).then(function({content,btn}){triggerEvent(btn,"post-body",content);triggerEvent(btn,"refresh")})}function triggerEvent($btnLayer,eventName,...args){const $btn=$($btnLayer);if(!$btn.data("layerConfig")){return}console.log("triggerEvent","getSetting",eventName);const settings=getSettings($btn);const event=$.Event(eventName+namespace);$btn.trigger(event,args);event.stopPropagation();if(eventName!=="all"){const allEvent=$.Event(`all${namespace}`);$btn.trigger(allEvent,[eventName+namespace,...args]);$.bsLayer.utils.executeFunction(settings.onAll,eventName+namespace,...args);allEvent.stopPropagation();const eventFunctionName=`on${eventName.split("-").map(word=>word.charAt(0).toUpperCase()+word.slice(1)).join("")}`;$.bsLayer.utils.executeFunction(settings[eventFunctionName],...args)}}function getSettings($btnLayer){return $($btnLayer).data("layerConfig").settings}function setSettings($btnLayer,settings){$($btnLayer).data("layerConfig").settings=settings}function btnEvents($btnLayer){$($btnLayer).off("click"+namespace).on("click"+namespace,function(e){e.preventDefault();if($.bsLayer.vars.isAnimating){return}open($(e.currentTarget))})}function closeLatestLayer($layer,clickedOnBackdrop=false){if($.bsLayer.vars.isAnimating){return}if(clickedOnBackdrop){if(["static"].includes($layer.attr("data-bs-backdrop"))){return}}close($layer)}function getCurrentWidth($btnLayer){console.log("getCurrentWidth","getSetting");const settings=getSettings($btnLayer);const config=$.bsLayer.getConfig();const openLayerIds=$.bsLayer.vars.openLayers;const countOpenLayers=openLayerIds.length;const winWidth=$(window).width();if(winWidth<576){return winWidth}if(settings.width){return settings.width}if(countOpenLayers===1){return Math.round(winWidth*.8)}let prevWidth=Math.round(winWidth*.8);if(countOpenLayers>1){const prevLayerId=openLayerIds[countOpenLayers-2];const $prevLayer=getLayerById(prevLayerId);if($prevLayer.length&&$prevLayer.width()){prevWidth=$prevLayer.width()}}return Math.max(prevWidth-config.distanceBetweenLayers,576)}function getCurrentZIndex(){const config=$.bsLayer.getConfig();const countOpenLayers=$.bsLayer.vars.openLayers.length;return config.zIndexStart+countOpenLayers}function getLoading(){return['<div class="d-flex justify-content-center fs-1 align-items-center h-100 w-100">','<div class="spinner-border text-primary" style="width: 5rem; height: 5rem;" role="status">','<span class="visually-hidden">Loading...</span>',"</div>","</div>"].join("")}function getTemplate(settings){const config=$.bsLayer.getConfig();const closeableBtn=!settings.closeable?"":[`<button type="button" class="btn" data-bs-dismiss="layer"><i class="${config.icons.close}"></i></button>`].join("");const maxMinBtn=!settings.expandable?"":[`<button type="button" class="btn btn-toggle-full-width"><i class="${config.icons.maximize}"></i></button>`].join("");return['<div class="d-flex flex-column align-items-stretch h-100 w-100">','<div class="layer-header d-flex flex-nowrap justify-content-between align-items-center p-3">',`<h5 class="layer-title">${settings.title||""}</h5>`,'<div class="btn-group">',maxMinBtn,closeableBtn,"</div>","</div>",'<div class="layer-body p-3 flex-fill overflow-y-auto"></div>',"</div>"].join("")}function fetchContent($btnLayer,$layer,triggerRefresh=false){return new Promise((resolve,reject)=>{const settings=getSettings($btnLayer);const config=$.bsLayer.getConfig();const layerBody=$layer.find(".layer-body");layerBody.html(getLoading());if(!settings.url){reject("Settings.url not defined!");return}const query=typeof settings.queryParams==="function"?settings.queryParams():{};let promise;if(typeof settings.url==="function"){try{promise=Promise.resolve($.bsLayer.utils.executeFunction(settings.url,query))}catch(err){reject(err);return}}else{promise=$.ajax({url:settings.url,type:config.ajax.method||"GET",data:query,contentType:config.ajax.contentType||"application/x-www-form-urlencoded; charset=UTF-8"})}if(promise&&typeof promise.then==="function"){promise.then(function(res){const $content=$(res);$(layerBody).empty().append($content);resolve({content:$content,btn:$btnLayer})}).catch(function(error){console.error("Error loading the layer:",error);reject(error)})}else{const errMsg="Settings.url muss eine Promise liefernde Funktion oder eine URL sein!";console.error(errMsg);reject(errMsg)}})}function getLayerById(id){return $(`.bs-layer[id="${id}"]`)}function getLayerByButton($btnLayer){return $(`.bs-layer[id="${$btnLayer.attr("aria-controls")}"]`)}function getButtonByLayer($layer){return $('.btn-layer[aria-controls="'+$layer.attr("id")+'"]')}function getLayerIdByButton($btnLayer){return $($btnLayer).attr("aria-controls")}function open($btnLayer){if($.bsLayer.vars.isAnimating){return}$.bsLayer.vars.isAnimating=true;const settings=getSettings($btnLayer);const layerId=getLayerIdByButton($btnLayer);const config=$.bsLayer.getConfig();const animationDuration=config.animationDuration;const baseName=!settings.name?"layer"+($.bsLayer.vars.openLayers.length+1):$.bsLayer.utils.toCamelCase(settings.name);const nameExists=$.bsLayer.vars.openLayers.some(layerId=>{const $layer=getLayerById(layerId);return $layer.attr("data-name")===baseName});if(nameExists){if(typeof config.onError==="function"){config.onError('A layer with the name "'+baseName+'" is already open!')}$.bsLayer.vars.isAnimating=false;return}triggerEvent($btnLayer,"show");$.bsLayer.vars.openLayers.push(layerId);const width=getCurrentWidth($btnLayer);const zIndex=getCurrentZIndex();const $layer=$("<div>",{"data-bs-backdrop":typeof settings.backdrop==="boolean"?settings.backdrop?"true":"false":"static",class:"position-fixed text-dark top-0 h-100 rounded-start-5 bs-layer sliding","data-name":baseName,"data-bs-theme":"light",id:layerId,html:getTemplate(settings),css:{width:width+"px",right:"-"+width+"px",zIndex:zIndex,transition:"right "+animationDuration+"ms",display:"block",background:"rgba(255, 255, 255, 0.74)",boxShadow:"0 16px 80px rgba(0, 0, 0, 0.7)",backdropFilter:"blur(9.1px)",WebkitBackdropFilter:"blur(9.1px)"}}).appendTo(config.parent);void $layer[0].offsetWidth;$layer.css("right","0");for(let i=0;i<$.bsLayer.vars.openLayers.length-1;i++){const $layer2=getLayerById($.bsLayer.vars.openLayers[i]);$layer2.addClass("overflow-hidden")}$layer.removeClass("overflow-hidden");let $backdrop=$("#"+backdropId);if($backdrop.length===0){$backdrop=$(`<div id="${backdropId}" class="modal-backdrop fade show"></div>`).appendTo("body")}else{$backdrop.appendTo("body")}const backdropZ=zIndex-1;$backdrop.css({zIndex:backdropZ});if(settings.backdrop===false){$backdrop.css({"background-color":"transparent",opacity:0,"pointer-events":"auto"})}else{$backdrop.css({"background-color":"",opacity:"","pointer-events":"auto"})}if($.bsLayer.vars.openLayers.length===1){$("body").addClass("overflow-hidden")}fetchContent($btnLayer,$layer).then(function({content,btn}){triggerEvent(btn,"post-body",content)});setTimeout(()=>{triggerEvent($btnLayer,"shown");$layer.css("transition","none");$layer.removeClass("sliding");$layer.addClass("show");$.bsLayer.vars.isAnimating=false},animationDuration)}function close($layer){if($.bsLayer.vars.isAnimating){return}if(!$layer.length){$.bsLayer.onError("No layer found to close!");return}$.bsLayer.vars.isAnimating=true;const config=$.bsLayer.getConfig();const animationDuration=config.animationDuration;const $layerBtn=getButtonByLayer($layer);if(!$layerBtn.length||typeof $layerBtn.data("layerConfig")!=="object"){$.bsLayer.utils.executeFunction($.bsLayer.onError,"No controller found for layer!");return}console.log("close","getSetting");const settings=getSettings($layerBtn);const width=$layer&&$layer.outerWidth?$layer.outerWidth():0;$layer.css("transition","right "+animationDuration+"ms");triggerEvent($layerBtn,"hide");if($.bsLayer.vars.openLayers.length===1){$("#"+backdropId).remove()}else if($.bsLayer.vars.openLayers.length>1){const underLayerId=$.bsLayer.vars.openLayers[$.bsLayer.vars.openLayers.length-2];const $underLayer=getLayerById(underLayerId);const zIndex=$underLayer&&$underLayer.css?parseInt($underLayer.css("z-index"),10)||1050:1050;$("#"+backdropId).css({zIndex:zIndex-1})}const $currentBackdrop=$("#"+backdropId);if($currentBackdrop.length){if(settings.backdrop===false){$currentBackdrop.css({"background-color":"transparent",opacity:0,"pointer-events":"auto"})}else{$currentBackdrop.css({"background-color":"",opacity:"","pointer-events":"auto"})}}if($layer.css){$layer.css("right","-"+width+"px");$layer.addClass("sliding");$layer.removeClass("show");setTimeout(function(){$layer.hide(function(){triggerEvent($layerBtn,"hidden");$layer.remove();$.bsLayer.vars.openLayers.pop();if($.bsLayer.vars.openLayers.length){const lastLayerId=$.bsLayer.vars.openLayers[$.bsLayer.vars.openLayers.length-1];const $lastLayer=getLayerById(lastLayerId);$lastLayer.removeClass("overflow-hidden")}else{$("body").removeClass("overflow-hidden")}$.bsLayer.vars.isAnimating=false})},animationDuration)}else{$.bsLayer.vars.isAnimating=false}}function closeAll(){const vars=$.bsLayer.vars;if(vars.isAnimating||!vars.openLayers.length){return}function closeNext(){if(!vars.openLayers.length){return}const latestLayerId=vars.openLayers[$.bsLayer.vars.openLayers.length-1];const $layer=getLayerById(latestLayerId);close($layer);if(vars.openLayers.length>0){setTimeout(function waitAndClose(){if(!vars.isAnimating){closeNext()}else{setTimeout(waitAndClose,30)}},30)}}closeNext()}function toggleExpand(){if(!$.bsLayer.vars.openLayers.length){return}const latestLayerId=$.bsLayer.vars.openLayers[$.bsLayer.vars.openLayers.length-1];const $layer=getLayerById(latestLayerId);if(!$layer.length){return}const config=$.bsLayer.getConfig();const $layerMaxMinBtn=$layer.find(".btn-toggle-full-width i");$layer.toggleClass("w-100");$layerMaxMinBtn.removeClass(config.icons.maximize).removeClass(config.icons.minimize);if($layer.hasClass("w-100")){$layer.removeClass("rounded-start-5");$layerMaxMinBtn.addClass(config.icons.minimize)}else{$layer.addClass("rounded-start-5");$layerMaxMinBtn.addClass(config.icons.maximize)}}function globalEvents(){$(document).on("click"+namespace,".bs-layer .btn-toggle-full-width",function(e){e.preventDefault();e.stopPropagation();toggleExpand()}).on("click"+namespace,'.bs-layer [data-bs-dismiss="layer"]',function(e){e.preventDefault();const closetLayer=$(e.currentTarget).closest(".bs-layer");alert(closetLayer.attr("id"));closeLatestLayer(closetLayer)}).on("click"+namespace,"#"+backdropId,function(e){e.preventDefault();const latestLayerId=$.bsLayer.vars.openLayers[$.bsLayer.vars.openLayers.length-1];const latestLayer=getLayerById(latestLayerId);closeLatestLayer(latestLayer,true)});$(document).on("keydown"+namespace,function(e){if(e.key==="Escape"){if($.bsLayer.vars.openLayers.length){if($.bsLayer.vars.isAnimating){return}const latestLayerId=$.bsLayer.vars.openLayers[$.bsLayer.vars.openLayers.length-1];const latestLayer=getLayerById(latestLayerId);if(!latestLayer.length){return}if(["static"].includes(latestLayer.attr("data-bs-backdrop"))){return}close(latestLayer)}}})}})(jQuery);